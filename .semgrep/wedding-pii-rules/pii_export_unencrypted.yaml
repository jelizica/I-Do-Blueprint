rules:
  - id: wedding-pii-export-unencrypted
    severity: WARNING
    metadata:
      author: I Do Blueprint Security Team
      references:
        - https://www.sentra.io/learn/pii-compliance-checklist
        - https://www.nightfall.ai/blog/pii-compliance-checklist-best-practices
        - https://complydog.com/blog/pii-data-protection-guide-personally-identifiable-information-management
      category: security
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      technology: [ios, swift, wedding-planning, data-export]
      cwe: CWE-311
      owasp: A02:2021-Cryptographic Failures
    message: >-
      This wedding planning application exports Personally Identifiable Information (PII)
      to unencrypted file formats (CSV, Excel, JSON) without proper security warnings or
      encryption.

      EXPORT RISKS:
      1. CSV/XLSX files are unencrypted by default (plaintext on disk)
      2. User may share files via email, Slack, cloud storage (no access controls)
      3. Files may be backed up to iCloud/Dropbox without user awareness
      4. Once exported, data is outside GDPR/RLS controls (no way to revoke access)

      PII TYPICALLY EXPORTED FROM WEDDING APPS:
      - Guest lists: 500+ names, emails, phones, addresses
      - Dietary restrictions (health data - HIPAA/state law implications)
      - Accessibility needs (disability information - ADA protected)
      - Vendor contact info (business contacts, phone numbers)
      - Payment records (financial data - PCI DSS if credit cards mentioned)

      2024 COMPLIANCE REQUIREMENTS:
      - GDPR Article 32: "Encryption of personal data"
      - CCPA: Reasonable security measures for exported consumer data
      - State health privacy laws: Encryption required for health-related exports

      REMEDIATION:
      ✅ Show warning dialog before export: "This file contains sensitive guest information..."
      ✅ Offer encrypted export option (password-protected ZIP, encrypted PDF)
      ✅ Add export audit logging: who exported what, when
      ✅ Implement data minimization: only export necessary fields
      ✅ Add "Exclude Health Data" toggle (dietary/accessibility fields)
      ✅ Generate temporary export links (Supabase Storage with signed URLs, 24hr expiry)
      ✅ Add watermarks/metadata: "Confidential - Delete after \(weddingDate)"

      EXAMPLE - SECURE EXPORT FLOW:
      ✅ User clicks "Export Guest List"
      ✅ Alert: "This will export 127 guests with email/phone/dietary info. Encrypt?"
      ✅ Options: [Cancel] [Export Encrypted] [Export Unencrypted (Unsafe)]
      ✅ Log: "User exported guest_list.csv at 2024-01-01 14:23:45"
      ❌ Silently export all guest data to unencrypted CSV
    languages: [swift]
    patterns:
      - pattern-either:
          # Pattern 1: CSV export without encryption warning
          - patterns:
              - pattern-inside: |
                  func $FUNC(...) {
                    ...
                    $CSV = $GUESTS.map { ... }.joined(separator: ...)
                    ...
                    try $CSV.write(to: $URL, ...)
                    ...
                  }
              - metavariable-regex:
                  metavariable: $FUNC
                  regex: (?i)(export|download|save|generate).*CSV
              - pattern-not-inside: |
                  // SECURITY: User acknowledged PII export risk
                  ...
              - pattern-not-inside: |
                  showExportWarning()
                  ...

          # Pattern 2: Excel/XLSX export
          - patterns:
              - pattern-inside: |
                  func $FUNC(...) {
                    ...
                  }
              - metavariable-regex:
                  metavariable: $FUNC
                  regex: (?i)(export|generate).*(Excel|XLSX|Spreadsheet)
              - pattern-not-inside: |
                  // Encrypted export
                  ...

          # Pattern 3: JSON export with PII fields
          - patterns:
              - pattern-inside: |
                  let encoder = JSONEncoder()
                  ...
                  let data = try encoder.encode($OBJ)
                  ...
                  try data.write(to: $URL)
              - metavariable-regex:
                  metavariable: $OBJ
                  regex: (guests|guestList|vendors|vendorList|contacts)
              - pattern-not-inside: |
                  // Encrypted JSON export
                  ...

          # Pattern 4: Share sheet without PII warning
          - patterns:
              - pattern-inside: |
                  func $FUNC(...) {
                    ...
                    let activityVC = UIActivityViewController(activityItems: [$ITEM], ...)
                    ...
                  }
              - metavariable-regex:
                  metavariable: $FUNC
                  regex: (?i)(share|export)
              - metavariable-regex:
                  metavariable: $ITEM
                  regex: (?i)(.*URL.*|.*csv.*|.*json.*|.*excel.*)
              - pattern-not-inside: |
                  // WARNING: Sharing file with PII
                  ...

          # Pattern 5: Google Sheets API export (third-party PII disclosure)
          - patterns:
              - pattern-inside: |
                  func $FUNC(...) {
                    ...
                    $CLIENT.appendRow(..., values: $VALUES, ...)
                    ...
                  }
              - metavariable-regex:
                  metavariable: $CLIENT
                  regex: (?i)(google|sheets|drive|api)
              - metavariable-regex:
                  metavariable: $VALUES
                  regex: (?i)(guest|vendor|contact)
              - pattern-not-inside: |
                  // User consented to Google Sheets export
                  ...

          # Pattern 6: Batch export operations
          - patterns:
              - pattern-inside: |
                  func exportAll$TYPE(...) {
                    ...
                  }
              - metavariable-regex:
                  metavariable: $TYPE
                  regex: (Guests|Vendors|Contacts|Data)
              - pattern-not-inside: |
                  guard userConsentedToExport else { ... }

          # Pattern 7: File writing with PII-containing filenames
          - patterns:
              - pattern: try $DATA.write(to: $URL, ...)
              - metavariable-regex:
                  metavariable: $URL
                  regex: (?i).*(guest|vendor|contact|list).*\.(csv|json|xlsx)
              - pattern-not-inside: |
                  // Encrypted file export
                  ...
