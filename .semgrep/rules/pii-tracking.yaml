rules:
  # Guest PII Detection
  - id: guest-pii-database-query
    pattern-either:
      - pattern: |
          .from("guest_list")
      - pattern: |
          .from("guests")
    message: |
      Guest PII database access detected. Ensure:
      - Row Level Security (RLS) is enabled
      - couple_id filter is applied
      - Data is not logged or exposed in errors
    severity: WARNING
    languages: [swift]
    metadata:
      category: security
      subcategory: [privacy]
      cwe: "CWE-359: Exposure of Private Personal Information to an Unauthorized Actor"
      owasp: "A01:2021 - Broken Access Control"
      references:
        - https://owasp.org/Top10/A01_2021-Broken_Access_Control/

  - id: guest-email-exposure
    pattern-either:
      - pattern: |
          print($GUEST.email)
      - pattern: |
          logger.debug(..., $GUEST.email, ...)
      - pattern: |
          logger.info(..., $GUEST.email, ...)
    message: |
      Guest email (PII) logged or printed. This violates privacy best practices.
      Use logger.debug() only and ensure logs are not sent to third parties.
    severity: WARNING
    languages: [swift]
    metadata:
      category: security
      subcategory: [privacy]
      gdpr: true

  - id: sensitive-data-in-error-messages
    pattern-either:
      - pattern: |
          throw ...(message: "... \($GUEST.firstName) ...")
      - pattern: |
          throw ...(message: "... \($GUEST.email) ...")
      - pattern: |
          throw ...(message: "... \($GUEST.phoneNumber) ...")
    message: |
      Sensitive guest data included in error message. This could leak PII in logs.
      Use generic error messages and log details separately with proper masking.
    severity: ERROR
    languages: [swift]
    metadata:
      category: security
      subcategory: [privacy]

  # Budget/Financial Data
  - id: budget-data-logging
    pattern-either:
      - pattern: |
          print($BUDGET.totalAmount)
      - pattern: |
          logger.$METHOD(..., $EXPENSE.amount, ...)
    message: |
      Financial data logged. Ensure sensitive budget information is not exposed.
    severity: INFO
    languages: [swift]

  # Vendor PII
  - id: vendor-contact-exposure
    pattern-either:
      - pattern: |
          print($VENDOR.email)
      - pattern: |
          print($VENDOR.phone)
    message: |
      Vendor contact information (PII) exposed in logs.
    severity: WARNING
    languages: [swift]

  # Supabase RLS Checks
  - id: missing-couple-id-filter
    pattern: |
      .from($TABLE)
       .select()
    pattern-not: |
      .from($TABLE)
       .select()
       .eq("couple_id", ...)
    message: |
      Database query without couple_id filter detected.
      This could leak data across tenants. Always filter by couple_id for multi-tenancy.
    severity: ERROR
    languages: [swift]
    metadata:
      category: security
      subcategory: [auth, privacy]
      multi-tenancy: true

  - id: uuid-to-string-conversion
    pattern-either:
      - pattern: |
          .eq($COLUMN, value: $UUID.uuidString)
      - pattern: |
          .neq($COLUMN, value: $UUID.uuidString)
    message: |
      UUID converted to string for query. This causes case mismatch bugs.
      Pass UUID directly: .eq("couple_id", value: tenantId)
    severity: ERROR
    languages: [swift]
    metadata:
      category: correctness
      bug-pattern: uuid-case-mismatch

  # Keychain Security
  - id: insecure-keychain-accessibility
    pattern-not-regex: "kSecAttrAccessibleWhenUnlockedThisDeviceOnly"
    pattern-regex: "kSecAttrAccessible.*"
    message: |
      Keychain item uses accessibility level other than kSecAttrAccessibleWhenUnlockedThisDeviceOnly.
      This could allow session data to be backed up and restored to other devices.
    severity: WARNING
    languages: [swift]
    metadata:
      category: security
      subcategory: [keychain]

  # Hardcoded Secrets
  - id: hardcoded-api-key
    pattern-either:
      - pattern: |
          let $VAR = "$SECRET"
      - pattern: |
          var $VAR = "$SECRET"
    metavariable-pattern:
      metavariable: $VAR
      patterns:
        - pattern-regex: ".*(key|token|secret|password|api).*"
    message: |
      Possible hardcoded secret detected. Use AppConfig or environment variables instead.
    severity: ERROR
    languages: [swift]

  # Privacy Manifest Checks (iOS/macOS)
  - id: required-reason-api-usage
    pattern-either:
      - pattern: FileManager.default.contentsOfDirectory(...)
      - pattern: UserDefaults.standard
      - pattern: NSPersistentContainer(...)
    message: |
      Using Required Reason API. Ensure Privacy Manifest (PrivacyInfo.xcprivacy) documents this usage.
    severity: INFO
    languages: [swift]
    metadata:
      category: compliance
      apple-privacy-manifest: true

  # ===== ADDITIONAL SECURITY RULES =====

  # Auth Token Storage
  - id: auth-token-in-userdefaults
    pattern-either:
      - pattern: |
          UserDefaults.standard.set($TOKEN, forKey: $KEY)
      - pattern: |
          UserDefaults.standard.setValue($TOKEN, forKey: $KEY)
    metavariable-pattern:
      metavariable: $KEY
      patterns:
        - pattern-regex: ".*(token|session|auth|jwt|bearer|api_key|access|refresh).*"
    message: |
      Auth token stored in UserDefaults detected. UserDefaults is not encrypted.
      Use Keychain (SessionManager) for sensitive auth data.
      SECURITY RISK: Tokens in UserDefaults can be extracted from backups.
    severity: ERROR
    languages: [swift]
    metadata:
      category: security
      subcategory: [auth, storage]
      cwe: "CWE-922: Insecure Storage of Sensitive Information"

  # Service Role Key (Critical)
  - id: service-role-key-in-client
    pattern-regex: "service_role|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\\.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ii4qIiwicm9sZSI6InNlcnZpY2Vfcm9sZSI"
    message: |
      CRITICAL: service_role key detected in client code!
      service_role keys bypass Row Level Security and should NEVER be in client apps.
      This is a CRITICAL security vulnerability allowing full database access.
      Remove immediately and use anon key only.
    severity: ERROR
    languages: [swift]
    metadata:
      category: security
      subcategory: [auth, secrets]
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A07:2021 - Identification and Authentication Failures"

  # Database Error Exposure
  - id: database-error-exposed-to-user
    pattern-either:
      - pattern: showError($ERROR.localizedDescription)
      - pattern: print($ERR as PostgrestError)
      - pattern: logger.error(..., $ERR.localizedDescription, ...)
    message: |
      Database error may be exposed to user. Error messages can reveal:
      - Database schema details
      - Table/column names
      - SQL syntax
      Use generic error messages for users. Log detailed errors securely.
    severity: WARNING
    languages: [swift]
    metadata:
      category: security
      subcategory: [information-disclosure]
      cwe: "CWE-209: Generation of Error Message Containing Sensitive Information"

  # CSV/XLSX Export PII Warning
  - id: pii-export-without-sanitization
    pattern-either:
      - pattern: |
          exportToCSV(guests: $GUESTS)
      - pattern: |
          exportToExcel(guests: $GUESTS)
      - pattern: |
          GuestExportService.$METHOD($GUESTS)
    message: |
      Exporting guest PII to file. Ensure:
      - User consent for data export
      - Secure file permissions (user-only access)
      - Exported files are not synced to cloud (exclude from iCloud)
      - File deletion after use
    severity: INFO
    languages: [swift]
    metadata:
      category: privacy
      gdpr: true

  # Unsafe Query String Building
  - id: unsafe-query-string-interpolation
    pattern-either:
      - pattern: |
          .from("\($TABLE)")
      - pattern: |
          .select("\($COLUMNS)")
      - pattern: |
          .eq("\($COLUMN)", value: "\($VALUE)")
    message: |
      String interpolation in database query detected.
      This could lead to SQL injection if user input is interpolated.
      Use parameterized queries: .eq("column", value: safeValue)
    severity: WARNING
    languages: [swift]
    metadata:
      category: security
      subcategory: [injection]
      cwe: "CWE-89: SQL Injection"

  # Auth State in Logs
  - id: auth-state-logged
    pattern-either:
      - pattern: |
          logger.$METHOD(..., $SESSION, ...)
      - pattern: |
          print($SESSION)
      - pattern: |
          logger.$METHOD(..., $USER.accessToken, ...)
    message: |
      Auth session or token logged. This could expose:
      - Access tokens
      - Refresh tokens
      - User session identifiers
      Avoid logging auth state. Use session IDs only for debugging.
    severity: WARNING
    languages: [swift]
    metadata:
      category: security
      subcategory: [auth, logging]

  # Missing RLS in Realtime Channels
  - id: realtime-channel-without-rls-filter
    pattern: |
      supabase.realtime.channel($CHANNEL)
    pattern-not: |
      supabase.realtime.channel($CHANNEL)
        ...
        .eq("couple_id", ...)
    message: |
      Realtime channel subscription without couple_id filter.
      This could broadcast data across tenants. Apply RLS filters to realtime channels.
      Example: .on(.insert, schema: "public", table: "guests", filter: "couple_id=eq.\(tenantId)")
    severity: ERROR
    languages: [swift]
    metadata:
      category: security
      subcategory: [auth, multi-tenancy]
