# Backup of original tests.yml
# Disabled on 2026-01-03 due to failing CI
# See tests.yml for new minimal configuration

name: Test Suite (DISABLED)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Run Unit Tests
        run: |
          xcodebuild test \
            -scheme "I Do Blueprint" \
            -destination 'platform=macOS' \
            -only-testing:I_Do_BlueprintTests \
            -enableCodeCoverage YES \
            -derivedDataPath .build \
            | xcpretty --color --simple

      - name: Generate Code Coverage Report
        run: |
          xcrun xccov view --report --json .build/Logs/Test/*.xcresult > coverage.json
          echo "Coverage report generated"

      - name: Check Coverage Threshold
        run: |
          coverage=$(xcrun xccov view --report .build/Logs/Test/*.xcresult | grep "I Do Blueprint.app" | awk '{print $4}' | sed 's/%//')
          echo "Code coverage: ${coverage}%"

          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "âŒ Coverage ${coverage}% is below 80% threshold"
            exit 1
          else
            echo "âœ… Coverage ${coverage}% meets 80% threshold"
          fi

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.json
          flags: unittests
          name: codecov-umbrella

  integration-tests:
    name: Integration Tests
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Integration Tests
        run: |
          xcodebuild test \
            -scheme "I Do Blueprint" \
            -destination 'platform=macOS' \
            -only-testing:I_Do_BlueprintTests/Integration \
            | xcpretty --color --simple

  ui-tests:
    name: UI Tests
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run UI Tests
        run: |
          xcodebuild test \
            -scheme "I Do Blueprint" \
            -destination 'platform=macOS' \
            -only-testing:I_Do_BlueprintUITests \
            | xcpretty --color --simple

  performance-tests:
    name: Performance Tests
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Performance Tests
        run: |
          xcodebuild test \
            -scheme "I Do Blueprint" \
            -destination 'platform=macOS' \
            -only-testing:I_Do_BlueprintTests/Performance \
            | xcpretty --color --simple

      - name: Extract Performance Metrics
        run: |
          echo "ðŸ“Š Performance Test Results:"
          xcrun xccov view --report .build/Logs/Test/*.xcresult | grep -A 20 "Performance"

  accessibility-tests:
    name: Accessibility Tests
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Accessibility Tests
        run: |
          xcodebuild test \
            -scheme "I Do Blueprint" \
            -destination 'platform=macOS' \
            -only-testing:I_Do_BlueprintTests/Accessibility \
            | xcpretty --color --simple

  build:
    name: Build Verification
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Application
        run: |
          xcodebuild build \
            -scheme "I Do Blueprint" \
            -destination 'platform=macOS' \
            -derivedDataPath .build \
            | xcpretty --color --simple

  lint:
    name: SwiftLint
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Mint
        run: brew install mint

      - name: Cache Mint packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.mint
          key: ${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      - name: Run SwiftLint
        run: |
          mint run realm/SwiftLint swiftlint --strict --reporter github-actions-logging

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, ui-tests, performance-tests, accessibility-tests, build, lint]
    if: always()

    steps:
      - name: Check Test Results
        run: |
          echo "## ðŸ“‹ Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| UI Tests | ${{ needs.ui-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility Tests | ${{ needs.accessibility-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any test failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.ui-tests.result == 'failure' ||
          needs.performance-tests.result == 'failure' ||
          needs.accessibility-tests.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.lint.result == 'failure'
        run: exit 1
